<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Toolkit</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- pdf-lib CDN -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    /* Dark mode support */
    .dark { background-color: #1a202c; color: #edf2f7; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .border-gray-300 { border-color: #4a5568; }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <!-- Header -->
  <header class="p-4 bg-white dark:bg-gray-800 shadow">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">PDF Toolkit</h1>
      <button id="theme-toggle" class="py-1 px-3 bg-gray-200 dark:bg-gray-700 rounded">Toggle Dark Mode</button>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto flex-grow p-4">
    <!-- Upload Area -->
    <div id="drop-area" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded p-8 text-center">
      <p>Drag & drop PDF files here or click to upload</p>
      <input type="file" id="fileElem" multiple accept="application/pdf" class="hidden" />
    </div>

    <!-- File List Preview -->
    <ul id="file-list" class="mt-4 space-y-2"></ul>

    <!-- Controls -->
    <div class="mt-4 flex space-x-2">
      <button id="mergeBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Merge PDF</button>
      <button id="splitBtn" class="px-4 py-2 bg-green-600 text-white rounded">Split PDF</button>
    </div>

    <!-- Split Options Modal -->
    <div id="split-options" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
      <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg w-full max-w-md">
        <h2 class="text-xl font-semibold mb-4">Split Options</h2>
        <label class="block mb-2">
          Enter pages or ranges (e.g., 1,3-5):
          <input id="splitInput" type="text" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded" placeholder="e.g. 1,3-5" />
        </label>
        <div class="flex justify-end space-x-2">
          <button id="cancelSplit" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
          <button id="confirmSplit" class="px-4 py-2 bg-green-600 text-white rounded">Split</button>
        </div>
      </div>
    </div>

    <!-- Progress Indicator -->
    <div id="progressBar" class="mt-4 w-full bg-gray-200 dark:bg-gray-700 rounded h-4 overflow-hidden hidden">
      <div id="progress" class="h-full bg-blue-500" style="width: 0%;"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="p-4 bg-white dark:bg-gray-800 text-center shadow">
    &copy; <span id="year"></span> PDF Toolkit. All rights reserved.
  </footer>

  <!-- Scripts -->
  <script>
    // Initialization
    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');
    const fileList = document.getElementById('file-list');
    const mergeBtn = document.getElementById('mergeBtn');
    const splitBtn = document.getElementById('splitBtn');
    const splitModal = document.getElementById('split-options');
    const splitInput = document.getElementById('splitInput');
    const cancelSplit = document.getElementById('cancelSplit');
    const confirmSplit = document.getElementById('confirmSplit');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const themeToggle = document.getElementById('theme-toggle');

    let files = [];

    // Drag & drop handlers
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropArea.classList.add('bg-gray-100', 'dark:bg-gray-700');
      }, false);
    });

    ;['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropArea.classList.remove('bg-gray-100', 'dark:bg-gray-700');
      }, false);
    });

    dropArea.addEventListener('drop', (e) => {
      const dropped = [...e.dataTransfer.files];
      handleFiles(dropped);
    });

    dropArea.addEventListener('click', () => fileElem.click());
    fileElem.addEventListener('change', () => handleFiles([...fileElem.files]));

    function handleFiles(selected) {
      selected.forEach(file => {
        if (file.type !== 'application/pdf') {
          alert('Invalid file: ' + file.name);
          return;
        }
        if (file.size > 20 * 1024 * 1024) { // 20MB
          alert('File too large: ' + file.name);
          return;
        }
        files.push(file);
      });
      updateFileList();
    }

    function updateFileList() {
      fileList.innerHTML = '';
      files.forEach((file, idx) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded';
        li.innerHTML = `
          <span>${file.name} - ${(file.size/1024/1024).toFixed(2)} MB</span>
          <button class="text-red-500" onclick="removeFile(${idx})">Remove</button>
        `;
        fileList.appendChild(li);
      });
    }

    window.removeFile = (idx) => {
      files.splice(idx, 1);
      updateFileList();
    };

    // Merge
    mergeBtn.addEventListener('click', async () => {
      if (files.length < 2) return alert('Select at least two PDFs to merge.');
      progressBar.classList.remove('hidden');
      progress.style.width = '0%';

      const mergedPdf = await PDFLib.PDFDocument.create();
      let loaded = 0;
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
        const copied = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
        copied.forEach(page => mergedPdf.addPage(page));
        loaded++;
        progress.style.width = `${(loaded / files.length) * 100}%`;
      }
      const mergedBytes = await mergedPdf.save();
      download(new Blob([mergedBytes], { type: 'application/pdf' }), 'merged.pdf');
      progressBar.classList.add('hidden');
    });

    // Split
    splitBtn.addEventListener('click', () => {
      if (files.length !== 1) return alert('Select one PDF to split.');
      splitModal.classList.remove('hidden');
    });
    cancelSplit.addEventListener('click', () => splitModal.classList.add('hidden'));
    confirmSplit.addEventListener('click', async () => {
      const ranges = parseRanges(splitInput.value);
      if (!ranges.length) return alert('Enter valid ranges.');
      splitModal.classList.add('hidden');
      progressBar.classList.remove('hidden');
      progress.style.width = '0%';

      const file = files[0];
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
      const total = ranges.length;
      let count = 0;
      for (let i = 0; i < ranges.length; i++) {
        const [start, end] = ranges[i];
        const newDoc = await PDFLib.PDFDocument.create();
        const pages = await newDoc.copyPages(pdf, [...Array(end - start + 1).keys()].map(j => start - 1 + j));
        pages.forEach(p => newDoc.addPage(p));
        const bytes = await newDoc.save();
        download(new Blob([bytes], { type: 'application/pdf' }), `split_${i+1}.pdf`);
        count++;
        progress.style.width = `${(count/total)*100}%`;
      }
      progressBar.classList.add('hidden');
    });

    function parseRanges(input) {
      return input.split(',').map(part => {
        if (part.includes('-')) {
          const [s, e] = part.split('-').map(n => parseInt(n.trim()));
          return [s, e];
        } else {
          const p = parseInt(part.trim());
          return [p, p];
        }
      }).filter(r => r[0] && r[1] && r[0] > 0 && r[1] >= r[0]);
    }

    function download(blob, filename) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      document.documentElement.classList.toggle('light');
    });
  </script>
</body>
</html>
